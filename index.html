<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Lecteur chinois mot-à-mot</title>

<!-- Pickr (color pickers) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+SC:wght@500;600;700;800&display=swap" rel="stylesheet">

<style>
/* =====================================================
   Variables & Reset
   ===================================================== */
:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --brand:#0a84ff;
  --muted:#667085;
  --ring:rgba(10,132,255,.25);
  --radius:14px;
  --shadow:0 10px 28px rgba(20,20,20,.08);
  --space:clamp(14px,2.8vw,22px);
  --base:clamp(16px,3.8vw,18px);
  --h1:clamp(22px,7.2vw,34px);
  --chip:clamp(20px,5.6vw,24px);
  --textEdit:clamp(18px,4.8vw,20px);
}

*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0;
  font-family:"Inter",system-ui,Arial,sans-serif;
  background:transparent;
  color:#1f2937;
  font-size:var(--base);
  -webkit-text-size-adjust:100%;
}

/* =====================================================
   Home page layout
   ===================================================== */
.container{
  max-width:840px;
  margin:0 auto;
  padding:calc(var(--space) * 0.75);
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:var(--space);
}
h1{
  font-size:var(--h1);
  text-align:center;
  margin:0 0 10px;
  color:#1976d2;
  font-weight:800;
  letter-spacing:.2px;
}

/* CTA bas de page (Accueil) */
.cta-bar{
  position:sticky;
  bottom:max(12px, env(safe-area-inset-bottom));
  display:flex;
  justify-content:center;
  margin-top:var(--space);
  z-index:5;
}

/* =====================================================
   Buttons (generic)
   ===================================================== */
button:not(.ctrl-btn){
  appearance:none;
  border:none;
  border-radius:12px;
  padding:14px 20px;
  font-weight:700;
  cursor:pointer;
  transition:transform .06s ease, box-shadow .2s ease, background .2s ease;
}
.btn-primary{
  background:var(--brand);
  color:#fff;
  box-shadow:0 6px 18px rgba(10,132,255,.25);
}
.btn-primary:active{ transform:scale(.98) }
.btn-ghost{ background:#eef2f7; color:#111827 }

/* =====================================================
   Editor / Segmentation
   ===================================================== */
.input-wrap{ position:relative }
textarea{
  width:100%;
  min-height:170px;
  padding:16px 18px;
  font-family:"Noto Sans SC","Inter",sans-serif;
  font-size:var(--textEdit);
  font-weight:600;
  line-height:1.65;
  background:#fff;
  color:#111827;
  border:1px solid #e5e7eb;
  border-radius:12px;
  outline:none;
  box-shadow:inset 0 1px 0 rgba(16,24,40,.02);
}
textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 4px var(--ring) }

.segmented-box{
  border:1px dashed #d8dee9;
  border-radius:12px;
  padding:10px 10px 14px;
  min-height:160px;
  background:#fafcff;
}
#segmentedText{
  overflow-x:auto; overflow-y:hidden;
  white-space:nowrap;
  -webkit-overflow-scrolling:touch;
  padding:4px 2px;
}
.token{
  display:inline-block;
  margin:6px 8px;
  padding:8px 12px;
  border-radius:999px;
  background:#f1f5f9;
  color:#0f172a;
  font-family:"Noto Sans SC","Inter",sans-serif;
  font-size:var(--chip);
  font-weight:700;
  letter-spacing:.5px;
  user-select:none;
  transition:transform .12s ease, background .2s ease, color .2s ease;
}
.token:hover{ transform:translateY(-1px) }
#segmentedText .selected{ background:#ef4444; color:#fff; transform:scale(1.04) }

/* Crayon / validateur (bouton en bas de textarea) */
#toggleEdit{
  position:absolute;
  right:7px;
  bottom:7px;
  background:transparent;
  border:none;
  box-shadow:none;
  font-size:20px;
  cursor:pointer;
  color:#007bff;
  transition:transform .15s ease, color .2s ease;
}
#toggleEdit:hover{ transform:scale(1.15); color:#0056b3 }

/* Fieldsets */
fieldset{
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:16px;
  margin:var(--space) 0;
  background:#fff;
}
legend{ font-weight:800; color:#0f172a; padding:0 8px }

/* Slider */
.range{
  width:100%;
  margin-top:8px;
  -webkit-appearance:none; appearance:none; height:10px;
  background:linear-gradient(90deg,var(--brand),#93c5fd);
  border-radius:999px; outline:none;
}
.range::-webkit-slider-thumb{
  -webkit-appearance:none; appearance:none;
  width:28px; height:28px; border-radius:50%;
  background:#fff; border:3px solid var(--brand);
  box-shadow:0 2px 8px rgba(16,24,40,.2);
}
.range::-moz-range-thumb{
  width:28px; height:28px; border-radius:50%;
  background:#fff; border:3px solid var(--brand);
  box-shadow:0 2px 8px rgba(16,24,40,.2);
}

/* Switches */
.opt{ display:flex; align-items:center; gap:12px; margin:10px 0 }
.opt input[type="checkbox"]{
  appearance:none; width:54px; height:32px; border-radius:999px;
  background:#e5e7eb; position:relative; outline:none; cursor:pointer;
  transition:background .2s ease;
}
.opt input[type="checkbox"]::after{
  content:""; position:absolute; top:3px; left:3px;
  width:26px; height:26px; border-radius:50%;
  background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.2);
  transition:left .2s ease;
}
.opt input[type="checkbox"]:checked{ background:var(--brand) }
.opt input[type="checkbox"]:checked::after{ left:25px }
.opt span{ font-weight:600; color:#111827 }

/* Pickr rows */
.color-row{
  display:flex; justify-content:space-between; gap:18px; flex-wrap:wrap; padding:8px 0;
}
.swatch{ flex:1; min-width:130px; text-align:center }
.swatch > div .pcr-button{
  width:60px; height:60px; border-radius:50%;
  box-shadow:0 3px 10px rgba(0,0,0,.12); border:none;
}
.swatch label{ margin-top:6px; font-weight:600; font-size:14px; display:block }

/* =====================================================
   Selection overlay
   ===================================================== */
#selectionOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.45);
  z-index:1000; display:none;
  align-items:flex-start; justify-content:center;
  padding:40px 12px; overflow-y:auto;
}
#selectionOverlay .overlay-content{
  background:#fff; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.2);
  width:100%; max-width:760px; padding:16px; display:flex; flex-direction:column;
}
#overlayHeader{
  display:flex; justify-content:flex-end; padding:12px;
  background:#f5f5f5; border-bottom:1px solid #ddd;
}
#closeOverlay{ background:transparent; border:none; font-size:28px; cursor:pointer; color:#444 }
#segmentedOverlayText{ flex:1; overflow-y:auto; padding:16px; white-space:normal; line-height:1.8 }
#segmentedOverlayText span{
  display:inline-block; margin:6px 8px; padding:8px 12px;
  border-radius:6px; background:#f1f5f9; font-size:22px; font-weight:600; cursor:pointer;
}
#segmentedOverlayText span.selected{ background:#ef4444; color:#fff }

/* =====================================================
   Reading page (fullscreen)
   ===================================================== */
#displayPage{
  display:none;
  position:fixed; inset:0;
  width:100%; height:100%; overflow:hidden;
  background:var(--card);
}

/* Character area */
#charContainer{
  position:relative;
  height:calc(100dvh - 110px);
  width:100%;
  display:flex; align-items:center; justify-content:center;
  padding:12px;
}
#charDisplay{
  display:flex; justify-content:center; align-items:baseline;
  gap:.12em; white-space:nowrap; line-height:1;
  font-family:"Noto Sans SC",sans-serif; font-weight:800;
}
#charDisplay span{ display:inline-flex; width:1em; justify-content:center; align-items:center; text-align:center }
#charDisplay .han, #charDisplay .punc{ font-weight:800 }
#charDisplay.shifted{ transform:translateX(.4em) }

#pinyin,#defs{
  position:absolute; left:50%; transform:translateX(-50%);
  text-align:center; width:100%; padding:0 12px;
}
#pinyin{ top:calc(50% + 12vh); font-size:clamp(22px,6.2vw,34px); font-weight:700 }
#defs{   top:calc(50% + 18vh); font-size:clamp(16px,4.4vw,24px); font-weight:600; color:#0f172ac7 }
#pinyin, #defs{ pointer-events:none } /* clic passe au caractère */

/* =====================================================
   Collapsible controls
   ===================================================== */
/* small floating button (always visible) */
.floating-toggle {
  position: fixed;
  left: 50%;
  bottom: calc(env(safe-area-inset-bottom, 0) + 24px); /* avant 0 */
  transform: translateX(-50%);
  z-index: 3000;
  background: #111827;
  color: #fff;
  display: flex;  
  border: none;
  border-radius: 50%;
  font-weight: 900;           /* gras pour bien centrer */
  line-height: 1; 
  width: 48px;
  height: 48px;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,.3);
}

.floating-toggle span {
  display: inline-block;
  transform: translateX(-1px); /* ajuste la flèche vers la gauche */
  font-size: 22px;
  line-height: 1;
}

/* Barre centrée au-dessus du bouton */
#controls {
  display: none !important;
  position: fixed !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  bottom: calc(env(safe-area-inset-bottom, 0) + 24px + 60px) !important; /* bouton + marge */
  background: rgba(17,24,39,0.92);
  border-radius: 12px;
  padding: 10px;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  z-index: 2999;
}
/* visible when body has the flag */
body.controls-open #controls{ display:flex !important }
/* lift the toggle a bit when open (optional) */


/* buttons in the control bar */
#controls .ctrl-btn{
  all:unset;
  -webkit-appearance:none; appearance:none;
  display:flex; align-items:center; justify-content:center;
  width:64px; height:64px;
  border-radius:14px;
  background:#111827; color:#fff;
  font-size:28px; font-weight:900;
  cursor:pointer; text-align:center; line-height:1;
}
#controls .ctrl-btn:focus{ outline:none }

/* glyph for restart button */
#startTextBtn{ display:grid; place-items:center }
#startTextBtn::before{
  content:"⟳";
  display:block;
  font-size:44px; font-weight:900;
  font-family:"Segoe UI Symbol","Noto Sans Symbols 2","Arial Unicode MS",sans-serif;
  line-height:1;
  transform:translateY(-0.10em);
}

/* force pause button look the same as others */
#pauseBtn{
  -webkit-appearance:none !important; appearance:none !important;
  background:#111827 !important; color:#fff !important;
  font-size:32px !important; font-weight:900 !important; line-height:1 !important;
  border:none !important; outline:none !important; box-shadow:none !important;
}

/* =====================================================
   Mobile tweaks
   ===================================================== */
@media (max-width:600px){
  .container{
    padding:max(10px, env(safe-area-inset-left)) max(10px, env(safe-area-inset-right));
  }
  .card{ padding:calc(var(--space) * .9) }
  .opt{ gap:14px }
  .swatch{ min-width:130px }
  .cta-bar .btn-primary{ width:100% }

  #controls .ctrl-btn{ width:56px; height:56px; font-size:26px }

  #charContainer{ height:calc(100dvh - 110px) }
  #charDisplay{ font-size:80px }
  #charDisplay.long-seq{ font-size:clamp(28px, 6vw, 40px) }

  /* spacing character → pinyin → translation (mobile) */
  #pinyin{ top:calc(50% + 8vh) }
  #defs{   top:calc(50% + 12vh) }
}
</style>
</head>

<body>
  <div class="container">
    <div class="card" id="homePage">
      <h1>Lecteur chinois mot-à-mot</h1>

      <div class="input-wrap">
        <div id="editorArea">
          <textarea id="inputText">你好，我们是学生。老师喜欢中国。</textarea>
        </div>
        <div id="segmentedArea" style="display:none;">
          <div id="segmentedText" class="segmented-box"></div>
        </div>
        <button id="toggleEdit" aria-label="Basculer édition/segmentation">✏️</button>
      </div>

      <fieldset>
        <legend>Paramètres de lecture</legend>
        <div>
          <label>Vitesse (mots/min) : <strong id="speedLabel">120</strong></label>
          <input class="range" type="range" id="speed" min="30" max="360" step="10" value="120">
        </div>
        <div class="opt">
          <input type="checkbox" id="showPinyin"><span>Afficher le pinyin</span>
        </div>
        <div class="opt">
          <input type="checkbox" id="showDefs"><span>Afficher la traduction</span>
        </div>
      </fieldset>

      <fieldset>
        <legend>Couleurs</legend>
        <div class="color-row">
          <div class="swatch">
            <div id="bgColorPicker"></div>
            <label for="bgColorPicker">Fond</label>
          </div>
          <div class="swatch">
            <div id="textColorPicker"></div>
            <label for="textColorPicker">Mots</label>
          </div>
          <div class="swatch">
            <div id="highlightBgColorPicker"></div>
            <label for="highlightBgColorPicker">Fond 2</label>
          </div>
          <div class="swatch">
            <div id="highlightColorPicker"></div>
            <label for="highlightColorPicker">Mots 2</label>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Dictionnaire</legend>
        <button class="btn-ghost" id="loadDict">Charger CC-CEDICT</button>
        <input type="file" id="dictFile" accept=".u8,.txt" style="display:none">
        <span id="dictStatus" style="margin-left:8px;color:var(--muted)">Aucun dictionnaire chargé</span>
      </fieldset>

      <div class="cta-bar">
        <button class="btn-primary" id="startBtn">▶ Démarrer la lecture</button>
      </div>
    </div>
  </div>

  <!-- Overlay plein écran pour la sélection -->
  <div id="selectionOverlay">
    <div class="overlay-content">
      <div id="overlayHeader">
        <button id="closeOverlay" aria-label="Fermer la sélection">✖</button>
      </div>
      <div id="segmentedOverlayText"></div>
    </div>
  </div>

  <!-- Page de lecture -->
  <div id="displayPage">
    <div id="charContainer">
      <div id="charDisplay"></div>
      <div id="pinyin"></div>
      <div id="defs"></div>
    </div>

    <!-- bouton toggle + barre -->
    <button id="toggleControls" class="floating-toggle" aria-label="Ouvrir les contrôles">
  <span id="toggleArrow">▲</span>
</button>
    <div id="controls">
      <button id="startTextBtn"    class="ctrl-btn" title="Revenir au début"></button>
      <button id="prevSentenceBtn" class="ctrl-btn" title="Phrase précédente">&lt;&lt;</button>
      <button id="sentenceStartBtn"class="ctrl-btn" title="Début de phrase">|&lt;</button>
      <button id="prevWordBtn"     class="ctrl-btn" title="Mot précédent">&lt;</button>
      <button id="pauseBtn"        class="ctrl-btn" title="Lecture/Pause">▶</button>
      <button id="nextWordBtn"     class="ctrl-btn" title="Mot suivant">&gt;</button>
      <button id="nextSentenceBtn" class="ctrl-btn" title="Phrase suivante">&gt;&gt;</button>
      <button id="quitBtn"         class="ctrl-btn" title="Quitter">✖</button>
    </div>
  </div>

<script>
// ========= État global =========
let dict = { entries: new Map(), wordSet: new Set(), maxLen: 1 };
let tokens = [];
let idx = 0;
let timer = null;
let playing = true;
let highlightWords = [];
let currentToken = null;
let editMode = true;

// ========= Utilitaires =========
function numericToDiacriticPinyin(pinyin){
  const toneMarks={a:['ā','á','ǎ','à'],e:['ē','é','ě','è'],i:['ī','í','ǐ','ì'],o:['ō','ó','ǒ','ò'],u:['ū','ú','ǔ','ù'],ü:['ǖ','ǘ','ǚ','ǜ']};
  function applyMark(s,tIndex){
    for(const l of ['a','o','e']){const i=s.toLowerCase().indexOf(l); if(i!==-1) return s.slice(0,i)+toneMarks[l][tIndex]+s.slice(i+1);}
    for(let i=s.length-1;i>=0;i--){const c=s[i].toLowerCase(); if(toneMarks[c]) return s.slice(0,i)+toneMarks[c][tIndex]+s.slice(i+1);}
    return s;
  }
  const normalized=pinyin.replace(/u:/g,'ü').replace(/U:/g,'Ü').replace(/\bv/g,'ü').replace(/\bV/g,'Ü');
  return normalized.replace(/([A-Za-zü:]+)([0-5])/g,(m,sy,t)=>{const tone=+t; if(tone===0||tone===5) return sy.replace(/:/g,''); return applyMark(sy,tone-1);});
}
function normalizeChineseText(text){
  text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');
  text=text.replace(/([\p{Script=Han}])\p{White_Space}+(?=[\p{Script=Han}])/gu,'$1');
  text=text.replace(/\p{White_Space}+([，。！？、；：,.!?;:])/gu,'$1').replace(/([，。！？、；：,.!?;:])\p{White_Space}+/gu,'$1');
  return text;
}
function parseCedict(raw){
  const entries=new Map(), wordSet=new Set(); let maxLen=1;
  for(const line of raw.split(/\r?\n/)){
    const L=line.trim(); if(!L||L.startsWith("#")) continue;
    const m=L.match(/^(\S+)\s+(\S+)\s+\[([^\]]+)\]\s+\/(.+)\/$/); if(!m) continue;
    const simp=m[2], pinyin=numericToDiacriticPinyin(m[3]), defs=m[4].split("/").map(d=>numericToDiacriticPinyin(d.trim())).filter(Boolean);
    if(!entries.has(simp)) entries.set(simp,{simp, pinyin, defs});
    wordSet.add(simp); if(simp.length>maxLen) maxLen=simp.length;
  }
  return { entries, wordSet, maxLen };
}
const isHan = ch => /[\u3400-\u9FFF\uF900-\uFAFF]/.test(ch);

function segmentText(text, wordSet, maxLen){
  const t=[]; let i=0;
  while(i<text.length){
    const ch=text[i];
    if(isHan(ch)){
      let matched=null;
      for(let L=Math.min(maxLen,text.length-i); L>=1; L--){
        const cand=text.slice(i,i+L);
        if(wordSet.has(cand)){ matched=cand; break; }
      }
      if(matched){
        t.push({type:'han', text:matched});
        i+=matched.length;
        if(/[。！？,.，!?]/.test(text[i])){ t[t.length-1].text+=text[i]; i++; }
      }else{
        t.push({type:'han', text:ch}); i++;
      }
    }else{
      t.push({type:'other', text:ch}); i++;
    }
  }
  return t;
}
function attachDictInfo(tokens, dictMap){
  return tokens.map(tok=>{
    if(tok.type==='han'){
      const clean=tok.text.replace(/[。！？,.，!?]$/,'');
      const e=dictMap.get(clean);
      if(e) return {...tok, pinyin:e.pinyin, defs:e.defs};
    }
    return tok;
  });
}

// ========= Rendu (accueil) =========
function renderSegmented(){
  const text = normalizeChineseText(document.getElementById('inputText').value);
  const segmented = attachDictInfo(segmentText(text, dict.wordSet, dict.maxLen), dict.entries);
  const c = document.getElementById('segmentedText'); 
  c.innerHTML = '';

  segmented.forEach((tok, i) => {
    const el = document.createElement('span');
    el.className = 'token';
    el.textContent = tok.text;

    const clean = tok.text.replace(/[。！？,.，!?]$/, '');
    if (highlightWords.includes(clean)) el.classList.add('selected');

    // ✅ clic sur le token
    el.addEventListener('click', (e) => {
      e.stopPropagation();

      // toggle surlignage
      if (highlightWords.includes(clean)) {
        highlightWords = highlightWords.filter(w => w !== clean);
      } else {
        highlightWords.push(clean);
      }
      renderSegmented();

      // ✅ afficher directement infos du mot
      showToken(tok);
    });

    // ✅ bouton ▶ lecture depuis ce mot
    const play = document.createElement('button');
    play.className = 'chip-play';
    play.textContent = '▶';
    play.title = 'Lire à partir de ce mot';
    play.addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('homePage').style.display = 'none';
      const dp = document.getElementById('displayPage');
      dp.style.display = 'block';
      dp.style.visibility = 'visible';
      restartFrom(i);
      forcePlay();
    });

    el.appendChild(play);
    c.appendChild(el);
  });
}



// ========= Rendu (page de jeu) =========
function showToken(token) {
  currentToken = token;

  const cd   = document.getElementById('charDisplay');
  const pEl  = document.getElementById('pinyin');
  const dEl  = document.getElementById('defs');
  const cont = document.getElementById('charContainer');

  cd.innerHTML = '';
  pEl.textContent = '';
  dEl.textContent = '';
  pEl.style.display = '';
  dEl.style.display = '';

  // --- ponctuation finale ---
  let han = token.text, punc = '';
  if (/[。！？,.，!?]$/.test(token.text)) {
    han  = token.text.slice(0, -1);
    punc = token.text.slice(-1);
  }

  // --- caractères ---
  if (han) {
    for (const ch of han) {
      const s = document.createElement('span');
      s.className = 'han';
      s.textContent = ch;
      cd.appendChild(s);
    }
  }
  if (punc) {
    const sp = document.createElement('span');
    sp.className = 'punc';
    sp.textContent = punc;
    cd.appendChild(sp);
    cd.classList.add('shifted');
  } else {
    cd.classList.remove('shifted');
  }

  // --- couleurs dynamiques ---
  const normalBg      = (bgColorPicker?.getColor()?.toHEXA().toString())           || '#ffffff';
  const normalText    = (textColorPicker?.getColor()?.toHEXA().toString())         || '#000000';
  const highlightBg   = (highlightBgColorPicker?.getColor()?.toHEXA().toString())  || '#000000';
  const highlightText = (highlightColorPicker?.getColor()?.toHEXA().toString())    || '#ffffff';

  const clean = token.text.replace(/[。！？,.，!?]$/, '');
  const isH   = highlightWords.includes(clean);

  cd.style.color = isH ? highlightText : normalText;
  document.getElementById('displayPage').style.backgroundColor = isH ? highlightBg : normalBg;

  const contrast = getContrastingColor(isH ? highlightBg : normalBg);
  pEl.style.color = contrast;
  dEl.style.color = contrast;

  // --- écriture du contenu ---
  if (token.pinyin) pEl.textContent = token.pinyin;
  if (token.defs)   dEl.textContent = token.defs.join(', ');

  // --- affichage selon cases cochées ---
  const initShowPinyin = document.getElementById('showPinyin').checked;
  const initShowDefs   = document.getElementById('showDefs').checked;
  pEl.style.display = initShowPinyin ? '' : 'none';
  dEl.style.display = initShowDefs   ? '' : 'none';

  // --- taille dynamique ---
  const totalLen = han.length + (punc ? 1 : 0);
  if (totalLen >= 5) cd.classList.add('long-seq'); else cd.classList.remove('long-seq');
  if (typeof fitCharLine === 'function') fitCharLine();

  // --- clic sur le conteneur ---
  cont.dataset.toggled = '0';
  cont.onclick = (e) => {
    e.stopPropagation(); // ✅ évite conflit avec document.onclick

    const showPinyin = document.getElementById('showPinyin').checked;
    const showDefs   = document.getElementById('showDefs').checked;
    const toggled    = cont.dataset.toggled === '1';

    if (!showPinyin && !showDefs) {
      const bothHidden = (pEl.style.display === 'none' && dEl.style.display === 'none');
      pEl.style.display = bothHidden ? '' : 'none';
      dEl.style.display = bothHidden ? '' : 'none';
      cont.dataset.toggled = bothHidden ? '1' : '0';
      return;
    }

    if (!toggled) {
      if (showPinyin && !showDefs) {
        dEl.style.display = '';
      } else if (!showPinyin && showDefs) {
        pEl.style.display = '';
      } else { // les deux cochés
        pEl.style.display = 'none';
        dEl.style.display = 'none';
      }
      cont.dataset.toggled = '1';
    } else {
      pEl.style.display = showPinyin ? '' : 'none';
      dEl.style.display = showDefs   ? '' : 'none';
      cont.dataset.toggled = '0';
    }
  };
}


// ========= Page de lecture =========
function startDisplay() {
  document.getElementById('homePage').style.display = 'none';
  const dp = document.getElementById('displayPage');
  dp.style.display = 'block';
  dp.style.visibility = 'visible';

  const text = normalizeChineseText(document.getElementById('inputText').value);
  tokens = attachDictInfo(segmentText(text, dict.wordSet, dict.maxLen), dict.entries);
  idx = 0;

  if (!tokens.length) {
    alert("Aucun mot à afficher. Vérifie ton texte ou ta segmentation.");
    return;
  }
  clearInterval(timer);
  showToken(tokens[idx]);
  fitCharLine && fitCharLine();
}
function stopDisplay(){ clearInterval(timer); }

// ========= Navigation par phrase =========
const SENT_END_RE = /[。！？.!?]$/;
function computeSentenceStarts(tokArr){
  const starts = [0];
  for (let i=0;i<tokArr.length;i++){
    if (SENT_END_RE.test(tokArr[i].text)) starts.push(i+1);
  }
  if (starts[starts.length-1] === tokArr.length) starts.pop();
  return starts;
}
function findCurrentSentenceStart(tokArr, i){
  const starts = computeSentenceStarts(tokArr);
  let s = 0;
  for (const st of starts){ if(st <= i) s = st; else break; }
  return s;
}
function findNextSentenceStart(tokArr, i){
  const starts = computeSentenceStarts(tokArr);
  for (const st of starts){ if(st > i) return st; }
  return i;
}

// ========= Couleurs / contraste =========
function getContrastingColor(hex){
  hex = hex.replace('#','');
  if(hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
  const r = parseInt(hex.substr(0,2),16);
  const g = parseInt(hex.substr(2,2),16);
  const b = parseInt(hex.substr(4,2),16);
  const luminance = (0.299*r + 0.587*g + 0.114*b) / 255;
  return luminance > 0.6 ? "#000000" : "#ffffff";
}

// ========= Repositionnement lecture =========
function restartFrom(index){
  const text = normalizeChineseText(document.getElementById('inputText').value);
  tokens = attachDictInfo(segmentText(text, dict.wordSet, dict.maxLen), dict.entries);
  if (!tokens.length) return;

  idx = Math.max(0, Math.min(index, tokens.length-1));
  clearInterval(timer);
  showToken(tokens[idx]);
  fitCharLine && fitCharLine();
}

// ========= Boucle + Play/Pause =========
function forcePause(){
  playing = false;
  clearInterval(timer);
  const pb = document.getElementById('pauseBtn');
  if (pb) pb.textContent = '▶';
}
function forcePlay(){
  if (!tokens || !tokens.length) return;
  playing = true;
  const pb = document.getElementById('pauseBtn');
  if (pb) pb.textContent = '⏸';
  showToken(tokens[idx]);
  startLoop();
}
function startLoop(){
  const speedEl = document.getElementById('speed');
  const speed = +(speedEl?.value || 120);
  const ms = Math.max(50, Math.round(60000 / Math.max(1, speed)));
  clearInterval(timer);
  timer = setInterval(()=>{
    if(!playing) return;
    idx++;
    if(idx < tokens.length){
      showToken(tokens[idx]);
      const clean = tokens[idx].text.replace(/[。！？,.，!?]$/,'');
      if (highlightWords.includes(clean)){
        forcePause();
      }
    }else{
      forcePause();
    }
  }, ms);
}

// ========= Ajuste la taille =========
function fitCharLine() {
  const container = document.getElementById('charContainer');
  const display   = document.getElementById('charDisplay');
  if (!container || !display) return;

  const isMobile = window.matchMedia('(max-width: 600px)').matches;
  const symbols  = display.querySelectorAll('.han, .punc').length;

  if (isMobile) {
    if (symbols <= 3) {
      display.style.fontSize = '80px';
      return;
    } else {
      let maxPx = 140;  const minPx = 28;
      let size = maxPx; let guard = 30;
      display.style.fontSize = size + 'px';
      while (
        guard-- > 0 &&
        (display.scrollWidth > container.clientWidth * 0.95 ||
         display.scrollHeight > container.clientHeight * 0.95)
      ) {
        size = Math.max(minPx, Math.floor(size * 0.92));
        display.style.fontSize = size + 'px';
      }
      return;
    }
  }

  const maxPx = Math.min(Math.floor(container.clientWidth * 0.85), 180);
  const minPx = 28;
  let size = maxPx; let guard = 30;
  display.style.fontSize = size + 'px';
  while (
    guard-- > 0 &&
    (display.scrollWidth > container.clientWidth * 0.98 ||
     display.scrollHeight > container.clientHeight * 0.98)
  ) {
    size = Math.max(minPx, Math.floor(size * 0.92));
    display.style.fontSize = size + 'px';
  }
}

// ========= Overlay =========
function openSelectionOverlay() {
  const text = normalizeChineseText(document.getElementById('inputText').value);
  const segmented = attachDictInfo(segmentText(text, dict.wordSet, dict.maxLen), dict.entries);

  const container = document.getElementById('segmentedOverlayText');
  container.innerHTML = '';

  segmented.forEach((tok, i) => {
    const el = document.createElement('span');
    el.textContent = tok.text;

    const clean = tok.text.replace(/[。！？,.，!?]$/, '');
    if (highlightWords.includes(clean)) el.classList.add('selected');

    el.addEventListener('click', () => {
      if (highlightWords.includes(clean)) {
        highlightWords = highlightWords.filter(w => w !== clean);
      } else {
        highlightWords.push(clean);
      }
      openSelectionOverlay();
    });

    container.appendChild(el);
  });

  document.getElementById('selectionOverlay').style.display = 'flex';
}
function closeSelectionOverlay() {
  document.getElementById('selectionOverlay').style.display = 'none';
  document.getElementById('editorArea').style.display = 'block';
  document.getElementById('segmentedArea').style.display = 'none';
  editMode = true;
  document.getElementById('toggleEdit').textContent = '✏️';
}

// ========= Events =========
window.addEventListener('resize', fitCharLine);
window.addEventListener('orientationchange', ()=> setTimeout(fitCharLine, 50));

document.addEventListener('DOMContentLoaded', () => {
  const $ = s => document.querySelector(s);

  // Vitesse
  $('#speed')?.addEventListener('input', e=>{
    $('#speedLabel').textContent = e.target.value;
    if (playing) startLoop();
  });

  // Démarrer
  $('#startBtn')?.addEventListener('click', ()=>{
    startDisplay();
    forcePlay();
  });

  // Play/Pause
  $('#pauseBtn')?.addEventListener('click', ()=>{
    if (!tokens || !tokens.length) return;
    if (idx >= tokens.length - 1) { restartFrom(0); forcePlay(); return; }
    if (playing) forcePause(); else forcePlay();
  });

  // Toggle controls (one button, global class on body)
const toggleBtn = document.getElementById('toggleControls');
const toggleArrow = document.getElementById('toggleArrow');
const controls  = document.getElementById('controls');

if (toggleBtn && controls){
  toggleBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    document.body.classList.toggle('controls-open');
    toggleArrow.textContent = document.body.classList.contains('controls-open') ? '▼' : '▲';
  });
  document.addEventListener('click', ()=>{
    if (document.body.classList.contains('controls-open')){
      document.body.classList.remove('controls-open');
      toggleArrow.textContent = '▲';
    }
  });
  controls.addEventListener('click', (e)=> e.stopPropagation());
}
  // Navigation
  $('#startTextBtn')?.addEventListener('click', ()=>{ restartFrom(0); forcePause(); });
  $('#prevSentenceBtn')?.addEventListener('click', ()=>{ 
    if (!tokens.length) return;
    const s = findCurrentSentenceStart(tokens, idx);
    const starts = computeSentenceStarts(tokens);
    let prevIdx = 0; for (const st of starts){ if(st < s) prevIdx = st; else break; }
    restartFrom(prevIdx); forcePause();
  });
  $('#sentenceStartBtn')?.addEventListener('click', ()=>{ if (!tokens.length) return; restartFrom(findCurrentSentenceStart(tokens, idx)); forcePause(); });
  $('#prevWordBtn')?.addEventListener('click', ()=>{ if (!tokens.length) return; restartFrom(Math.max(0, idx-1)); forcePause(); });
  $('#nextWordBtn')?.addEventListener('click', ()=>{ if (!tokens.length) return; restartFrom(Math.min(tokens.length-1, idx+1)); forcePause(); });
  $('#nextSentenceBtn')?.addEventListener('click', ()=>{ if (!tokens.length) return; restartFrom(findNextSentenceStart(tokens, idx)); forcePause(); });

  // Quitter
  $('#quitBtn')?.addEventListener('click', ()=>{
    forcePause();
    document.getElementById('charDisplay').innerHTML = '';
    document.getElementById('pinyin').textContent = '';
    document.getElementById('defs').textContent = '';
    idx = 0;
    document.getElementById('displayPage').style.display = 'none';
    document.getElementById('homePage').style.display = 'block';
  });

  // Éditeur / overlay
  $('#toggleEdit')?.addEventListener('click', openSelectionOverlay);
  $('#closeOverlay')?.addEventListener('click', closeSelectionOverlay);

  // Saisie / collage
  $('#inputText')?.addEventListener('paste', ()=>{ setTimeout(()=>{
    const input = document.getElementById('inputText');
    input.value = normalizeChineseText(input.value);
    renderSegmented();
  }, 50);});
  $('#inputText')?.addEventListener('input', e=>{
    const caret=e.target.selectionStart; const before=e.target.value;
    const after=normalizeChineseText(before);
    if(after!==before){ e.target.value=after; e.target.setSelectionRange(caret, caret); }
    renderSegmented();
  });

  // Dictionnaire
  $('#loadDict')?.addEventListener('click', ()=> $('#dictFile').click());
  $('#dictFile')?.addEventListener('change', e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      dict=parseCedict(reader.result);
      document.getElementById('dictStatus').textContent='Dictionnaire chargé ('+dict.wordSet.size+' mots)';
      renderSegmented();
    };
    reader.readAsText(file,'utf-8');
  });

  // Premier rendu
  renderSegmented();
});

// ========= Pickr defaults =========
const bgColorPicker = Pickr.create({
  el: '#bgColorPicker',
  theme: 'classic',
  default: '#FFE103',
  components: { preview: true, opacity: true, hue: true, interaction: { hex: true, rgba: true, input: true, save: true } }
});
const textColorPicker = Pickr.create({
  el: '#textColorPicker',
  theme: 'classic',
  default: '#000000',
  components: { preview: true, opacity: true, hue: true, interaction: { hex: true, rgba: true, input: true, save: true } }
});
const highlightBgColorPicker = Pickr.create({
  el: '#highlightBgColorPicker',
  theme: 'classic',
  default: '#000000',
  components: { preview: true, opacity: true, hue: true, interaction: { hex: true, rgba: true, input: true, save: true } }
});
const highlightColorPicker = Pickr.create({
  el: '#highlightColorPicker',
  theme: 'classic',
  default: '#FFE103',
  components: { preview: true, opacity: true, hue: true, interaction: { hex: true, rgba: true, input: true, save: true } }
});
</script>
</body>
</html>
